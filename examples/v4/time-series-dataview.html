<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>CARTO.js Time Series Dataview example</title>
    <!-- Include Leaflet 1.2.0 Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <!-- Fonts -->
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
    <!-- Include cartodb.js Library -->
    <script src="https://cdn.rawgit.com/CartoDB/cartodb.js/@4.0.0-alpha.29/carto.js"></script>
    <style>
      * { margin:0; padding:0; }
      html { box-sizing:border-box; height:100%; }
      body { background:#f2f6f9; height:100%; font-family:"Open sans", Helvetica, Arial, sans-serif; }
      #container { display:flex; width:100%; height:100%; }
      #map { flex:1; margin:10px; }
      #widgets { width:300px; margin:10px 10px 10px 0; }
      .widget { background:white; padding:10px; margin-bottom:10px; }
      .widget h1 { font-size:1.2em; }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="map"></div>
      <div id="widgets"> 
        <div id="widget" class="widget"></div>
        <p>This map shows train accidents in the United States between the years 2010 and early 2014</p>
        <p>The code shows how to create a time series widget. This widget shows temporal-data aggregated
          by a custom amount of time, in this case the data is aggregated by year.</p>
        <p>Hover over the bins to see the total amount per year.</p>
        <p>Zoom / pan the map to see the widget change.</p>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var div = document.getElementById('widget');
        window.widget = new Histogram({
          target: div
        });
        widget.set({ item: 'accidents '});
      });

      // 1. Setting up the Leaflet Map
      // 1.1 Creating the Leaflet Map centered in the united states.
      var map = L.map('map').setView([42, -100], 5);

      // 1.2 Adding basemap and labels layers
      // Adding Voyager Basemap
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'
      }).addTo(map);

      // 2 Defining a carto.Client
      var client = new carto.Client({
        apiKey: '84fdbd587e4a942510270a48e843b4c1baa11e18',
        username: 'cartojs-test'
      });

      // 3. Displaying on the map
      // 3.1 Defining the layer
      var source = new carto.source.Dataset('railroad_data');
      var style = new carto.style.CartoCSS(`
        #layer {
          marker-width: 10;
          marker-fill: red;
        }`
      );
      var layer = new carto.layer.Layer(source, style);

      // 3.2 Adding the layer to the client
      client.addLayer(layer);

      // 3.3. Adding the layers to the map
      client.getLeafletLayer().addTo(map);

      // 4 Creating a TimeSeries widget
      // 4.1 Defining a TimeSeries dataview, the second parameter is the column we want to aggregate.
      var timeSeries = new carto.dataview.TimeSeries(source, 'date', {
        aggregation: carto.dataview.timeAggregation.YEAR, // Aggregate the data by year
      });

      // 4.2 Listening to data changes on the dataview
      timeSeries.on('dataChanged', function (newData) {
        // Translate EPOCH timestamps to year
        if (newData && newData.bins.length > 0) {
          newData.bins.forEach(function (bin) {
            var newStart = new Date(0);
            newStart.setUTCSeconds(bin.start);
            var newEnd = new Date(0);
            newEnd.setUTCSeconds(bin.end);
            bin.start = newStart.getFullYear();
            bin.end = newEnd.getFullYear();
          });
        }
        widget && widget.set({ bins: newData.bins })
      });

      // Listen to timeSeries status, currently we are showing a console.log but looks like a good place to display a loader!
      timeSeries.on('statusChanged', function (newStatus, error) {
        console.log(newStatus)
      });

      // 4.3 Adding the dataviews to the client
      client.addDataview(timeSeries);

      // 5 Adding the bounding box filter
      // 5.1 Defining the bounding box filter for the map
      var boundingBoxFilter = new carto.filter.BoundingBoxLeaflet(map);

      // 5.2 Apply the bounding box filter to the dataview
      timeSeries.addFilter(boundingBoxFilter);
    </script>
    <!-- Include an external utility to draw histograms -->
    <script>
      /* histogram.html generated by Svelte v1.41.3 */
      var Histogram=function(){"use strict"
      function t(t,i,e){var n
      return function(){var r=this,s=arguments,o=function(){n=null,e||t.apply(r,s)},h=e&&!n
      clearTimeout(n),n=setTimeout(o,i),h&&t.apply(r,s)}}function i(t,i,e){return t&&t.length>0?Math.max((i-(t.length-1)*e)/t.length,0):0}function e(){return{bins:[],width:0,height:0,graphicX:0,graphicY:0,gutter:2,max:"",min:"",colors:["#c4e6c3","#96d2a4","#6dbc90","#4da284","#36877a","#266b6e","#1d4f60"],item:"apartments"}}function n(){this.updateGraphicSize(),window.addEventListener("resize",this.updateGraphicSize.bind(this)),this.hoverOutDebounced=t(function(){var t=this.refs.tooltip,i=this.refs.tooltipBg
      t.setAttributeNS(null,"visibility","hidden"),i.setAttributeNS(null,"visibility","hidden")},10)}function r(t,i){for(var e,n,r,o,h,a=t.bins,p=[],b=0;b<a.length;b+=1)p[b]=s(t,a,a[b],b,i)
      return{c:function(){e=l("div"),n=u("svg")
      for(var t=0;t<p.length;t+=1)p[t].c()
      r=u("rect"),o=u("text"),h=c("Tooltip"),this.h()},h:function(){e.className="histogram",f(n,"width","100%"),f(n,"height","128"),f(n,"version","1.1"),f(n,"xmlns","http://www.w3.org/2000/svg"),f(r,"class","tooltipBg"),f(r,"id","tooltipBg"),f(r,"x","0"),f(r,"y","0"),f(r,"width","52"),f(r,"height","24"),f(r,"visibility","hidden"),f(o,"class","tooltip"),f(o,"id","tooltip"),f(o,"font-family","Verdana"),f(o,"font-size","12"),f(o,"fill","white"),f(o,"x","0"),f(o,"y","0"),f(o,"visibility","hidden")},m:function(t,s){g(e,t,s),d(n,e),i.refs.graphic=n
      for(var a=0;a<p.length;a+=1)p[a].m(n,null)
      d(r,n),i.refs.tooltipBg=r,d(o,n),i.refs.tooltip=o,d(h,o)},p:function(t,e){var o=e.bins
      if(t.binWidth||t.gutter||t.height||t.bins||t.Math||t.colors||t.event){for(var h=0;h<o.length;h+=1)p[h]?p[h].p(t,e,o,o[h],h):(p[h]=s(e,o,o[h],h,i),p[h].c(),p[h].m(n,r))
      for(;h<p.length;h+=1)p[h].u(),p[h].d()
      p.length=o.length}},u:function(){_(e)
      for(var t=0;t<p.length;t+=1)p[t].u()},d:function(){i.refs.graphic===n&&(i.refs.graphic=null),v(p),i.refs.tooltipBg===r&&(i.refs.tooltipBg=null),i.refs.tooltip===o&&(i.refs.tooltip=null)}}}function s(t,i,e,n,r){var s,a,l,c,d
      return{c:function(){s=u("rect"),this.h()},h:function(){f(s,"x",a=n*(t.binWidth+t.gutter)+8),f(s,"y",l=t.height-e.normalized*t.height+8),f(s,"width",t.binWidth),f(s,"height",c=("Math"in t?t.Math:Math).max(e.freq*t.height-8,0)),f(s,"fill",d=t.bins.length>0?t.colors[("Math"in t?t.Math:Math).round(t.colors.length*n/t.bins.length)]:""),f(s,"stroke-width","0"),p(s,"mousemove",o),p(s,"mouseout",h),s._svelte={component:r,bins:i,index:n}},m:function(t,i){g(s,t,i)},p:function(t,i,e,n,r){(t.binWidth||t.gutter)&&a!==(a=r*(i.binWidth+i.gutter)+8)&&f(s,"x",a),(t.height||t.bins)&&l!==(l=i.height-n.normalized*i.height+8)&&f(s,"y",l),t.binWidth&&f(s,"width",i.binWidth),(t.Math||t.bins||t.height)&&c!==(c=("Math"in i?i.Math:Math).max(n.freq*i.height-8,0))&&f(s,"height",c),(t.bins||t.colors||t.Math)&&d!==(d=i.bins.length>0?i.colors[("Math"in i?i.Math:Math).round(i.colors.length*r/i.bins.length)]:"")&&f(s,"fill",d),s._svelte.bins=e,s._svelte.index=r},u:function(){_(s)},d:function(){b(s,"mousemove",o),b(s,"mouseout",h)}}}function o(t){var i=this._svelte.component,e=this._svelte.bins,n=this._svelte.index
      e[n]
      i.hoverRect(n,t)}function h(t){var i=this._svelte.component,e=this._svelte.bins,n=this._svelte.index
      e[n]
      i.hoverOutRect(n)}function a(t){m(this,t),this.refs={},this._state=w(e(),t.data),this._recompute({bins:1,width:1,gutter:1},this._state)
      var i=n.bind(this)
      t._root?this._root._oncreate.push(i):this._oncreate=[i],this._fragment=r(this._state,this),t.target&&(this._fragment.c(),this._fragment.m(t.target,t.anchor||null),y(this._oncreate))}function l(t){return document.createElement(t)}function u(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function c(t){return document.createTextNode(t)}function f(t,i,e){t.setAttribute(i,e)}function g(t,i,e){i.insertBefore(t,e)}function d(t,i){i.appendChild(t)}function _(t){t.parentNode.removeChild(t)}function v(t){for(var i=0;i<t.length;i+=1)t[i]&&t[i].d()}function p(t,i,e){t.addEventListener(i,e,!1)}function b(t,i,e){t.removeEventListener(i,e,!1)}function m(t,i){t.options=i,t._observers={pre:E(),post:E()},t._handlers=E(),t._root=i._root||t,t._bind=i._bind}function w(t){for(var i,e,n=1,r=arguments.length;n<r;n++){e=arguments[n]
      for(i in e)t[i]=e[i]}return t}function y(t){for(;t&&t.length;)t.pop()()}function x(t){this.destroy=R,this.fire("destroy"),this.set=this.get=R,!1!==t&&this._fragment.u(),this._fragment.d(),this._fragment=this._state=null}function M(t){return t?this._state[t]:this._state}function N(t,i){var e=t in this._handlers&&this._handlers[t].slice()
      if(e)for(var n=0;n<e.length;n+=1)e[n].call(this,i)}function S(t,i,e){var n=e&&e.defer?this._observers.post:this._observers.pre
      return(n[t]||(n[t]=[])).push(i),e&&!1===e.init||(i.__calling=!0,i.call(this,this._state[t]),i.__calling=!1),{cancel:function(){var e=n[t].indexOf(i)
      ~e&&n[t].splice(e,1)}}}function A(t,i){if("teardown"===t)return this.on("destroy",i)
      var e=this._handlers[t]||(this._handlers[t]=[])
      return e.push(i),{cancel:function(){var t=e.indexOf(i)
      ~t&&e.splice(t,1)}}}function W(t){this._set(w({},t)),this._root._lock||(this._root._lock=!0,y(this._root._beforecreate),y(this._root._oncreate),y(this._root._aftercreate),this._root._lock=!1)}function B(t){var i=this._state,e={},n=!1
      for(var r in t)C(t[r],i[r])&&(e[r]=n=!0)
      n&&(this._state=w({},i,t),this._recompute(e,this._state),this._bind&&this._bind(e,this._state),T(this,this._observers.pre,e,this._state,i),this._fragment.p(e,this._state),T(this,this._observers.post,e,this._state,i))}function z(t,i){this._fragment.m(t,i)}function O(){this._fragment.u()}function C(t,i){return t!==i||t&&"object"==typeof t||"function"==typeof t}function E(){return Object.create(null)}function R(){}function T(t,i,e,n,r){for(var s in i)if(e[s]){var o=n[s],h=r[s],a=i[s]
      if(a)for(var l=0;l<a.length;l+=1){var u=a[l]
      u.__calling||(u.__calling=!0,u.call(t,o,h),u.__calling=!1)}}}var k={updateGraphicSize:function(){var t=this.refs.graphic,i=t.getClientRects()
      if(i&&i.length>0)var e=i[0].width,n=i[0].height,r=i[0].x,s=i[0].y
      this.set({width:e,height:n,graphicX:r,graphicY:s})},hoverRect:function(t,i){function e(t){return t%1>0?t.toFixed(1):t}var n=this.get("bins")[t],r=e(n.start)+" - "+e(n.end)+": "+n.freq+" "+this.get("item"),s=this.refs.tooltip,o=this.refs.tooltipBg,h=i.clientX-this.get("graphicX")-48,a=i.clientY-this.get("graphicY")-32
      s.setAttributeNS(null,"visibility","visible"),s.setAttributeNS(null,"x",h+8),s.setAttributeNS(null,"y",a+16),s.firstChild.data=r,o.setAttributeNS(null,"visibility","visible")
      var l=s.getComputedTextLength()
      o.setAttributeNS(null,"x",h),o.setAttributeNS(null,"y",a),o.setAttributeNS(null,"width",l+16)},hoverOutRect:function(t){this.hoverOutDebounced.call(this)}}
      return w(a.prototype,k,{destroy:x,get:M,fire:N,observe:S,on:A,set:W,teardown:x,_set:B,_mount:z,_unmount:O}),a.prototype._recompute=function(t,e){(t.bins||t.width||t.gutter)&&C(e.binWidth,e.binWidth=i(e.bins,e.width,e.gutter))&&(t.binWidth=!0)},a}()
    </script>
  </body>
</html>
