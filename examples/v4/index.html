<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Basic Carto.js example</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <!--Include carto styles  -->
    <link rel="stylesheet" href="../../dist/themes/css/cartodb.css" />
    <!-- Include cartodb.js Library -->
    <script src="../../dist/cartodb.uncompressed.js"></script>
    <style>
        #map {
            width: 100vw;
            height: 100vh;
        }
        #widget {
            position: absolute;
            top: 0;
            right: 0;
            padding: 20px;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="widget"></div>
    <div id="map"></div>
    <script>
        (async () => {
            var i = 0; // Number of reload cycles.
            var map = L.map('map').setView([42.431234, -8.643616], 5);
            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png').addTo(map);

            // Create the Client
            var client = new carto.Client({
                apiKey: '84fdbd587e4a942510270a48e843b4c1baa11e18',
                serverUrl: 'https://{user}.carto.com:443',
                username: 'cartojs-test'
            });

            client.on(carto.EVENTS.SUCCESS, function () {
                console.log('Client reloaded', i++)
            });

            client.on(carto.EVENTS.ERROR, function () {
                console.error('Client Error!', i++)
            });

            // Create a source
            var source0 = new carto.source.Dataset('a0', 'ne_10m_populated_places_simple');
            window.source0 = source0;

            // Create a source
            var source1 = new carto.source.SQL('a1', 'SELECT * FROM ne_10m_populated_places_simple WHERE adm0name = \'Spain\'');
            window.source1 = source1;

            // Create a style
            var style = new carto.style.CartoCSS(`
                #layer {
                    marker-width: 10;
                    marker-fill: red;
                }`);

            // Create a style
            var style1 = new carto.style.CartoCSS(`
                #layer {
                    marker-width: 10;
                    marker-fill: yellow;
                }`);

            // Create a layer
            var layer = new carto.layer.Layer('layer0', source0, style);
            var layer1 = new carto.layer.Layer('layer1', source1, style1);

            client.addLayer(layer1);
            client.addLayer(layer);

            // Add the layers
            // await client.addLayers([layer1, layer]); // engine.reload() internal


            // Add the layer to the map
            client.getLeafletLayerView().addTo(map);

            client.removeLayer(layer);

            // Dataviews
            var formulaDataview = new carto.dataview.Formula(source1, 'pop_max', {
              operation: carto.OPERATION.AVG
            });
            window.formula1 = formulaDataview;

            formulaDataview.on('dataChanged', function (newData) {
              document.getElementById('widget').innerHTML = newData.operation.toUpperCase() + ' ' + newData.result;
              console.log('Data changed', newData);
            });

            formulaDataview.on('columnChanged', function (newColumn) {
              console.log('Column changed', newColumn);
            });

            formulaDataview.on('statusChanged', function (newStatus, error) {
              console.log('Status changed', newStatus, error);
              if (newStatus === carto.dataview.STATUS.LOADING) {
                console.log('loading');
              }
              if (newStatus === carto.dataview.STATUS.LOADED) {
                console.log('loaded');
              }
            });

            formulaDataview.on('operationChanged', function (newOperation) {
              console.log('Operation changed', newOperation);
            });

            client.addDataview(formulaDataview);

            formulaDataview.setOperation(carto.OPERATION.MAX);
        })();

    </script>
</body>

</html>
