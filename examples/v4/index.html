<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Basic Carto.js example</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <!--Include carto styles  -->
    <!-- <link rel="stylesheet" href="../../dist/themes/css/cartodb.css" /> -->
    <!-- Include cartodb.js Library -->
    <script src="../../dist/cartodb.uncompressed.js"></script>
    <style>
        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        (async () => {
            var i = 0; // Number of reload cycles.
            var map = window.map = L.map('map').setView([42.431234, -8.643616], 5);

            var popup = L.popup()
                .setLatLng({ lat: 0, lng: 0});

            L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png').addTo(map);

            // Create the Client
            var client = window.client = new carto.Client({
                apiKey: '84fdbd587e4a942510270a48e843b4c1baa11e18',
                serverUrl: 'https://{user}.carto.com:443',
                username: 'cartojs-test'
            });

            client.on(carto.Events.SUCCESS, function () {
                console.log('Client reloaded', i++)
            });

            client.on(carto.Events.ERROR, function () {
                console.error('Client Error!', i++)
            });

            // Create a source
            var spanishCitiesSource = new carto.source.SQL('a1', 'SELECT * FROM ne_10m_populated_places_simple WHERE adm0name = \'Spain\'');

            // Create a style
            var spanishCitiesStyle = new carto.style.CartoCSS(`
                #layer {
                    marker-width: 10;
                    marker-fill: red;
                }`);

            // Create a layer
            var spanishCities = window.spanishCities = new carto.layer.Layer(spanishCitiesSource, spanishCitiesStyle, {
              id: 'spanish_cities',
              featureClickColumns: ['adm0name'],
              featureOverColumns: ['adm0name']
            });


            // Create a source
            var populatedPlacesDataset = new carto.source.Dataset('ne_10m_populated_places_simple');

            // Create a style
            var populatedPlacesStyle = new carto.style.CartoCSS(`
                #layer {
                    marker-width: 10;
                    marker-fill: #CDCDCD;
                }`);


            var populatedPlaces = new carto.layer.Layer(populatedPlacesDataset, populatedPlacesStyle);

            client.addLayers([ spanishCities, populatedPlaces ]);

            spanishCities.on('feature:click', function (featureEvent) {
              console.log('feature:click', featureEvent.getLatLng(), featureEvent.getData());
            });

            spanishCities.on('feature:over', function (featureEvent) {
              var data = featureEvent.getData();
              var content = data.name;
              content += data.adm0name ? (' (' + data.adm0name + ')') : '';
              popup.setContent(content)
                .setLatLng(featureEvent.getLatLng())
                .openOn(map);

              console.log('feature:over', featureEvent.getLatLng(), featureEvent.getData());
            });

            spanishCities.on('feature:out', function (featureEvent) {
              console.log('feature:out', featureEvent.getLatLng(), featureEvent.getData());

              popup.removeFrom(map);
            });

            await spanishCities.setFeatureOverColumns(['adm0name', 'name']);

            // Add the layers
            // await client.addLayers([layer1, layer]); // engine.reload() internal

            // Add the layer to the map
            client.getLeafletLayerView().addTo(map);

            // client.getLeafletLayerView().removeFrom(map);
        })();

    </script>
</body>

</html>
