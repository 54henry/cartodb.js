<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Basic Carto.js example</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <!--Include carto styles  -->
    <link rel="stylesheet" href="../../dist/themes/css/cartodb.css" />
    <!-- Include cartodb.js Library -->
    <script src="../../dist/cartodb.uncompressed.js"></script>
    <style>
        #map {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        (async () => {
            var i = 0; // Number of reload cycles.
            var map = L.map('map').setView([42.431234, -8.643616], 5);

            // L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/rastertiles/voyager_nolabels/{z}/{x}/{y}.png').addTo(map);

            // Create the Client
            var client = new carto.Client({
                apiKey: '84fdbd587e4a942510270a48e843b4c1baa11e18',
                serverUrl: 'https://{user}.carto.com:443',
                username: 'cartojs-test'
            });

            client.on(carto.Events.SUCCESS, function () {
                console.log('Client reloaded', i++)
            });

            client.on(carto.Events.ERROR, function () {
                console.error('Client Error!', i++)
            });

            // Create a source
            var source1 = new carto.source.SQL('a1', 'SELECT * FROM ne_10m_populated_places_simple WHERE adm0name = \'Spain\'');

            // Create a style
            var style = new carto.style.CartoCSS(`
                #layer {
                    marker-width: 10;
                    marker-fill: red;
                }`);

            // Create a layer
            var layer = new carto.layer.Layer('layer0', source1, style, {
              featureClickColumns: ['adm0name'],
              featureOverColumns: ['adm0name']
            });

            client.addLayer(layer);


            layer.on('feature:click', function (featureEvent) {
              console.log('feature:click', featureEvent.getLatLng(), featureEvent.getData());
            });

            layer.on('feature:over', function (featureEvent) {
              console.log('feature:over', featureEvent.getLatLng(), featureEvent.getData());
            });

            layer.on('feature:out', function (featureEvent) {
              console.log('feature:out', featureEvent.getLatLng(), featureEvent.getData());
            });

            await layer.setFeatureOverColumns(['adm0name', 'name']);

            // Add the layers
            // await client.addLayers([layer1, layer]); // engine.reload() internal

            // Add the layer to the map
            client.getLeafletLayerView().addTo(map);


            layer.setFeatureOverColumns(['name']);
        })();

    </script>
</body>

</html>
