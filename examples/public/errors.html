<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>CARTO.js Guide</title>

  <!-- Include Leaflet 1.2.0 Library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

  <!-- Fonts -->
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>
  <!-- Include cartodb.js Library -->
  <script src="../../dist/public/carto.uncompressed.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    html {
      box-sizing: border-box;
      height: 100%;
    }

    body {
      background: #f2f6f9;
      height: 100%;
      font-family: "Open sans", Helvetica, Arial, sans-serif;
    }

    #container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    #map {
      flex: 1;
      margin: 10px;
    }

    #widgets {
      width: 300px;
      margin: 10px 10px 10px 0;
    }

    .widget {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
    }

    .widget h1 {
      font-size: 1.2em;
    }

    .widget-formula .result {
      font-size: 2em;
    }

    button {
      width: 100%;
      font-size: 13px;
      padding: 10px 20px 10px 20px;
      text-transform: uppercase;
      color: #FFF;
      border: none;
      margin-bottom: 5px;
    }

    button#btn1 {
      background: #F15743;
    }

    button#btn2 {
      background-color: #73C86B;
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="map"></div>
    <div id="widgets">
      <button id="btn1">Set Invalid Source</button>
      <button id="btn2">Set Valid Source</button>
      <p id="status"></p>
    </div>
  </div>
  <script>
    // 1. Setting up the Leaflet Map
    // 1.1 Creating the Leaflet Map
    var map = L.map('map').setView([58.722598828043395, 18.544921875000004], 4);

    // 1.2 Adding basemap and labels layers
    // Adding Voyager Basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy;<a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    // 2 Defining a carto.Client
    var client = new carto.Client({
      apiKey: '84fdbd587e4a942510270a48e843b4c1baa11e18',
      username: 'cartojs-test'
    });

    // 3.0 Define map sources
    // 3.0.1 Valid source with europe
    var validDataset = new carto.source.Dataset('ne_adm0_europe');
    // 3.0.1 This dataset does not exist in the server!
    var invalidDataset = new carto.source.Dataset('invalid_dataset');

    // Create a style and add the valid layer to the client
    var europeanCountriesStyle = new carto.style.CartoCSS(`#layer { polygon-fill: #0000FF; }`);

    // 3.3. Adding the layers to the map
    client.getLeafletLayer().addTo(map);

    // When click on btn 1 --> Add a layer with an invalid dataset.
    document.querySelector('#btn1').addEventListener('click', () => {
      addLayer(invalidDataset)
        .then(onSuccess)
        .catch(onError);
    });

    // Add a layer with an valid dataset.
    document.querySelector('#btn2').addEventListener('click', () => {
      addLayer(validDataset)
        .then(onSuccess)
        .catch(onError);
    });

    /**
     * Helper function used to add a layer to the map specifying the dataset.
     * Clear the map and add the new layer.
     */
    function addLayer(dataset) {
      var newLayer = new carto.layer.Layer(dataset, europeanCountriesStyle);
      // Clean the client first, once the client is empty add a new layer.
      return client.removeLayers(client.getLayers())
        .then(() => client.addLayer(newLayer));
    }

    /**
     * Helper function executed when the layer is added succesffuly
     */
    function onSuccess() {
      document.querySelector('#status').innerText = 'Map Loaded';
      document.querySelector('#status').style.color = 'green';
    }

    /**
     * Helper function executed when there are erros while adding a new layer.
     */
    function onError(cartoError) {
      document.querySelector('#status').innerText = cartoError.message;
      document.querySelector('#status').style.color = 'red';
    }
  </script>
</body>

</html>
