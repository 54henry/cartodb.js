<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Create and style clusters | CARTO</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="../../../dist/public/carto.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.43.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.43.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>


<div id='map'></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoicm9jaG9hIiwiYSI6IlUtOVdzLW8ifQ.aF6UbX1O-otpss1ZIwSQWw';
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v9',
    center: [-103.59179687498357, 40.66995747013945],
    zoom: 3
});

map.on('load', function() {
    (async () => {
        const client = new carto.Client({
            apiKey: 'YOUR_API_KEY',
            username: 'cartojs-test'
        });

        const source = new carto.source.Dataset('earthquakes');

        const layerAgg = new carto.layer.Layer(source, {
            id: 'clustered',
            maxzoom: 8,
            aggregation: {
                threshold: 1,
                resolution: 16,
                placement: 'point-grid',
                columns: {
                    'point_count': {
                        aggregate_function: 'count',
                        aggregated_column: '1'
                    }
                }
            }
        });
        const layer = new carto.layer.Layer(source, {
            id: 'unclustered',
            minzoom: 7,
            aggregation: false
        });

        await client.addLayers([layer, layerAgg]);
        var tilejson = client.getTilejson('vector');

        map.addSource("earthquakes", {
            type: "vector",
            tiles: tilejson.tiles
        });

        map.addLayer({
            id: "unclustered-point",
            type: "circle",
            source: "earthquakes",
            "source-layer": "unclustered",
            minzoom: 7,
            paint: {
                "circle-color": "#11b4da",
                "circle-radius": 4,
                "circle-stroke-width": 1,
                "circle-stroke-color": "#fff"
            }
        });

        map.addLayer({
            id: "clusters",
            type: "circle",
            source: "earthquakes",
            "source-layer": "clustered",
            maxzoom: 8,
            paint: {
                "circle-color": {
                    property: "point_count",
                    type: "interval",
                    stops: [
                        [0, "#51bbd6"],
                        [100, "#f1f075"],
                        [750, "#f28cb1"],
                    ]
                },
                "circle-radius": {
                    property: "point_count",
                    type: "interval",
                    stops: [
                        [0, 20],
                        [100, 30],
                        [750, 40]
                    ]
                }
            }
        });

        map.addLayer({
            id: "cluster-count",
            type: "symbol",
            source: "earthquakes",
            "source-layer": "clustered",
            layout: {
                "text-field": "{point_count}",
                "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                "text-size": 12
            }
        });
    })();
});
</script>

</body>
</html>
