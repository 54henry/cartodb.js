<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Basic Carto.js example</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>

  <!-- Include cartodb.js Library -->
  <script src="../../dist/public/carto.uncompressed.js"></script>
  <script src="./histogram.min.js"></script>
  <style>
    * { margin:0; padding:0; }
    html { box-sizing:border-box; height:100%; }
    body { background:#f2f6f9; height:100%; font-family:"Open sans", Helvetica, Arial, sans-serif; }
    #container { display:flex; width:100%; height:100%; }
    #map { flex:1; margin:10px; }
    #widgets { width:300px; margin:10px 10px 10px 0; }
    .widget { background:white; padding:10px; margin-bottom:10px; }
    .widget h1 { font-size:1.2em; }
    .widget-formula .result { font-size:2em; }
  </style>
</head>

<body>
  <div id="container">
    <div id="map"></div>
    <div id="widgets">
      <div id="widget" class="widget">
      </div>
      <p>Hover over the bins to get more info about the prices of the listings.</p>
      <p>Zoom / pan the map to see the histogram change.</p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var div = document.getElementById('widget');
      window.widget = new Histogram({
        target: div
      });
    });

    // Create the Leaflet Map
    var map = L.map('map').setView([40.4169, -3.7035], 11);

    // Add Voyager Basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy;<a href="https://carto.com/attribution">CARTO</a>'
    }).addTo(map);

    // Create the Client
    var client = new carto.Client({
      apiKey: '84fdbd587e4a942510270a48e843b4c1baa11e18',
      username: 'cartojs-test'
    });

    // Create a source
    var source0 = new carto.source.SQL('SELECT * FROM airbnb_listings WHERE price < 150');

    // Create a style
    var style = new carto.style.CartoCSS(`
      #layer {
        marker-width: 10;
        marker-fill: red;
      }`
    );

    // Create a layer
    var layer = new carto.layer.Layer(source0, style);

    // Add the layers
    client.addLayer(layer);

    // Add the layer to the map
    client.getLeafletLayer().addTo(map);

    // Dataviews
    var histogram = new carto.dataview.Histogram(source0, 'price');

    histogram.on('dataChanged', function (newData) {
      widget && widget.set({ bins: newData.bins })
    });

    histogram.on('statusChanged', function (newStatus, error) {
    });

    // Add Bounding box filter
    var bboxFilter = new carto.filter.BoundingBoxLeaflet(map);
    histogram.addFilter(bboxFilter);

    client.addDataview(histogram);
  </script>
</body>

</html>
