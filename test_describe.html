<!DOCTYPE html>
<html>
  <head>
    <title>Leaflet multilayer example | CartoDB.js</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <style>
      html, body {
        height: 100%;
        padding: 0;
        margin: 0;
      }
      .map {
        width: 400px;
        height: 400px;
        float: left;
      }
      .map .lengend {
        position: absolute;
        top: 10px;
        left: 10px;
      }
    </style>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
  </head>
  <body>
    <div id="map"></div>

    <!-- include cartodb.js library -->
    <script src="dist/cartodb.uncompressed.js"></script>
    <script>
      var account = 'eschbacher';

      var ramps = {
        green:  ['#EDF8FB', '#D7FAF4', '#CCECE6', '#66C2A4', '#41AE76', '#238B45', '#005824'],
        blue:  ['#FFFFCC', '#C7E9B4', '#7FCDBB', '#41B6C4', '#1D91C0', '#225EA8', '#0C2C84'],
        pink: ['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#E7298A', '#CE1256', '#91003F'],
        black:  ['#F7F7F7', '#D9D9D9', '#BDBDBD', '#969696', '#737373', '#525252', '#252525'],
        red:  ['#FFFFB2', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#B10026'],
        cat: ['#A6CEE3', '#1F78B4', '#B2DF8A', '#33A02C', '#FB9A99', '#E31A1C', '#FDBF6F', '#FF7F00', '#CAB2D6', '#6A3D9A', '#DDDDDD']
      };

      function geoAttr(geometryType) {
        return {
          "line": 'line-color',
          'polygon': "polygon-fill",
          'point': "marker-fill"
        }[geometryType]
      }

      var CSS = {
        choropleth: function(quartiles, prop, geometryType, ramp) {
          var attr = geoAttr(geometryType);
          var css = "#c{ " + attr + ": #0C2C84; polygon-opacity: 0.6; line-color: #0C2C84; line-width: 0.5; line-opacity: 1; } "
          for(var i = quartiles.length - 1; i >= 0; --i) {
            if(quartiles[i] !== undefined && quartiles[i] != null) {
              css += "\n#c[ " + prop + " <= " + quartiles[i] + "] {\n";
              css += attr  + ":" + ramp[i] + ";\n}"
            }
          }
          return css;
        },

        category: function(cats, prop, geometryType) {
          var attr = geoAttr(geometryType);
          var ramp = ramps.cat;
          var css = "#c{ " + attr + ": #0C2C84; polygon-opacity: 0.6; line-color: #0C2C84; line-width: 0.0; line-opacity: 1; } "
          for(var i = cats.length - 1; i >= 0; --i) {
            if(cats[i] !== undefined && cats[i] != null) {
              css += "\n#c[ " + prop + " = '" + cats[i] + "'] {\n";
              css += attr  + ":" + ramp[i] + ";\n}"
            }
          }
          return css;
        }

      }

      var s = cartodb.SQL({ user: account });
      function makeMap(div, sql, cartocss, bbox) {
        // create leaflet map
        var map = L.map(div, { 
          zoomControl: false,
          center: [43, 0],
          zoom: 3,
            scrollWheelZoom: false
        })

        map.fitBounds(bbox);

        // add a base layer
        L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
        }).addTo(map);

        // add cartodb layer with one sublayer
        cartodb.createLayer(map, {
          user_name: account,
          type: 'cartodb',
          sublayers: [{ sql: sql, cartocss: cartocss }]
        })
        .addTo(map)
      }

      function guessMap(sql, geometryType, column, stats, bbox) {
        var css = null
          var make_the_cut = ['areasource', 'bsmtcode', 'builtcode', 'irrlotcode', 'ownertype', 'plutomapid', 'proxcode', 'schooldist', 'splitzone'];
        if (false && stats.type == 'number') {
          css =  CSS.choropleth(stats.quantiles, column, geometryType, ramps.blue);
        } else if(stats.type == 'string') {

          css = CSS.category(stats.hist.slice(0, ramps.cat.length).map(function(r) { return r[0]; }), column, geometryType)
        }
        if (css) {
          var div = $('<div>')
          div.attr('class', 'map');
          $('body').append(div);
          makeMap(div[0], sql, css, bbox);
          if (make_the_cut.indexOf(column) != -1) {
              div.append($('<div>').text(column + " PASSES :) -- (#uniques: " + stats.distinct + ")").attr('class', 'lengend'));
              // console.log(stats);
          } else {
              div.append($('<div>').text(column + " DOESN'T PASS -- (#uniques: " + stats.distinct + ")").attr('class', 'lengend'));
          }
          
        }
      }

      function columnMap(sql, c, geometryType, bbox) {
        console.log(c);
        s.describe(sql, c, function(data) {
          console.log(data.column, data.avg);
          guessMap(sql, geometryType, data.column, data, bbox);
        });
      }

      function main() {
        var sql = 'select * from mnmappluto';//spanish_adm2_provinces'//world_borders' // pluto14v2
        s.describe(sql, 'the_geom', function(data) {
          var geometryType = data.simplified_geometry_type;
          s.columns(sql, function(columns) {
            _(columns).each(function(v, k) {
              columnMap(sql, k.concat(""), geometryType, data.bbox);
            })
          });
        })
      }

      // you could use $(window).load(main);
      window.onload = main; 

    </script>

  </body>
</html>
